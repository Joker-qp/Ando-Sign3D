import customtkinter as ctk
import cv2
import threading
from PIL import Image, CTkImage
import mediapipe as mp

# --- BAŞ DANIŞMAN NOTU: GÖRÜNTÜ İŞLEME AYARLARI ---
# MediaPipe Ayarları:
# min_detection_confidence: Elin ilk tespiti için güven eşiği (0.5 = %50)
# min_tracking_confidence: Takip sırasındaki güven eşiği.
mp_hands = mp.solutions.hands
mp_drawing = mp.solutions.drawing_utils
mp_drawing_styles = mp.solutions.drawing_styles

class AndoSignApp(ctk.CTk):
    def __init__(self):
        super().__init__()

        # 1. PENCERE AYARLARI
        self.title("Ando-Sign 3D: TİD Çeviri Sistemi - Prototip v2")
        self.geometry("1000x700")
        ctk.set_appearance_mode("Dark")
        
        # Değişkenler
        self.cap = None
        self.is_running = False
        self.thread = None

        # 2. ARAYÜZ TASARIMI (GRID SİSTEMİ)
        self.grid_columnconfigure(0, weight=1)
        self.grid_columnconfigure(1, weight=3) # Kamera alanı daha geniş olsun
        self.grid_rowconfigure(0, weight=1)

        # SOL PANEL (KONTROLLER)
        self.sidebar_frame = ctk.CTkFrame(self, width=200, corner_radius=0)
        self.sidebar_frame.grid(row=0, column=0, sticky="nsew")
        
        self.logo_label = ctk.CTkLabel(self.sidebar_frame, text="ANDO-SIGN 3D", font=ctk.CTkFont(size=20, weight="bold"))
        self.logo_label.grid(row=0, column=0, padx=20, pady=(20, 10))

        # Başlat Butonu
        self.btn_start = ctk.CTkButton(self.sidebar_frame, text="Sistemi Başlat", command=self.start_camera, fg_color="green")
        self.btn_start.grid(row=1, column=0, padx=20, pady=10)

        # Durdur Butonu
        self.btn_stop = ctk.CTkButton(self.sidebar_frame, text="Sistemi Durdur", command=self.stop_camera, fg_color="red", state="disabled")
        self.btn_stop.grid(row=2, column=0, padx=20, pady=10)

        # Durum Bilgisi
        self.status_label = ctk.CTkLabel(self.sidebar_frame, text="Durum: Beklemede", text_color="gray")
        self.status_label.grid(row=3, column=0, padx=20, pady=50)

        # SAĞ PANEL (KAMERA GÖRÜNTÜSÜ)
        self.camera_frame = ctk.CTkFrame(self, corner_radius=10)
        self.camera_frame.grid(row=0, column=1, padx=20, pady=20, sticky="nsew")
        
        # Görüntünün basılacağı yer (Label)
        self.video_label = ctk.CTkLabel(self.camera_frame, text="", corner_radius=10)
        self.video_label.pack(expand=True, fill="both", padx=10, pady=10)

    # 3. KAMERA BAŞLATMA MANTIĞI
    def start_camera(self):
        if not self.is_running:
            self.is_running = True
            self.cap = cv2.VideoCapture(0) # 0: Varsayılan Webcam
            
            # Butonları güncelle
            self.btn_start.configure(state="disabled")
            self.btn_stop.configure(state="normal")
            self.status_label.configure(text="Durum: Tarama Aktif", text_color="#00FF00")

            # Thread başlat (Arayüz donmasın diye)
            self.thread = threading.Thread(target=self.video_loop, daemon=True)
            self.thread.start()

    # 4. DURDURMA MANTIĞI
    def stop_camera(self):
        self.is_running = False
        if self.cap:
            self.cap.release()
        
        self.video_label.configure(image=None) # Görüntüyü temizle
        self.btn_start.configure(state="normal")
        self.btn_stop.configure(state="disabled")
        self.status_label.configure(text="Durum: Durduruldu", text_color="red")

    # 5. GÖRÜNTÜ İŞLEME DÖNGÜSÜ (BEYİN KISMI)
    def video_loop(self):
        with mp_hands.Hands(
            model_complexity=0, # Hız için 0, hassasiyet için 1
            min_detection_confidence=0.5,
            min_tracking_confidence=0.5) as hands:
            
            while self.is_running and self.cap.isOpened():
                ret, frame = self.cap.read()
                if not ret:
                    break

                # OpenCV BGR formatını RGB'ye çevir (MediaPipe ve CTk için)
                image = cv2.cvtColor(frame, cv2.COLOR_BGR2RGB)
                
                # Ayna etkisi (Kullanıcı kendini doğru görsün)
                image = cv2.flip(image, 1)

                # --- MEDIAPIPE İŞLEME ---
                results = hands.process(image)

                # Eğer el tespit edildiyse çizim yap
                if results.multi_hand_landmarks:
                    for hand_landmarks in results.multi_hand_landmarks:
                        mp_drawing.draw_landmarks(
                            image,
                            hand_landmarks,
                            mp_hands.HAND_CONNECTIONS,
                            mp_drawing_styles.get_default_hand_landmarks_style(),
                            mp_drawing_styles.get_default_hand_connections_style())
                        
                        # BURASI İLERİDE KOD YAZACAĞIN YER:
                        # hand_landmarks.landmark[8] -> İşaret parmağı ucu koordinatı
                        # Bu koordinatları alıp TİD algoritmamıza göndereceğiz.

                # Görüntüyü CTkImage formatına çevir
                img_pil = Image.fromarray(image)
                
                # Pencere boyutuna göre dinamik boyutlandırma (opsiyonel)
                ctk_img = CTkImage(light_image=img_pil, dark_image=img_pil, size=(640, 480))

                # Arayüzü güncelle (Ana thread'e güvenli erişim)
                try:
                    self.video_label.configure(image=ctk_img)
                    self.video_label.image = ctk_img
                except:
                    break # Pencere kapatıldıysa döngüyü kır

    # Uygulama kapatılırsa kamerayı serbest bırak
    def on_closing(self):
        self.stop_camera()
        self.destroy()

if __name__ == "__main__":
    app = AndoSignApp()
    app.protocol("WM_DELETE_WINDOW", app.on_closing)
    app.mainloop()